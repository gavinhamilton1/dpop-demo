<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Verify your sign-in â€¢ dpop.fun</title>
  <meta name="color-scheme" content="light dark">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-eval' 'unsafe-inline'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; base-uri 'none'">
  <link rel="stylesheet" href="/css/design-system.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/public/style.css">
  <style>
    /* Verify page specific styles */
    .verify-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .verify-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .verify-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 999px;
      background: var(--card);
      font-family: ui-monospace, monospace;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    
    .verify-title {
      font-size: 1.75rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--fg);
    }
    
    .verify-subtitle {
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.5;
    }
    
    .verify-grid {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem;
      margin-top: 2rem;
    }
    
    .verify-card {
      width: 100%;
      max-width: 500px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.5rem;
    }
    
    @media (max-width: 768px) {
      .verify-grid {
        gap: 1.5rem;
      }
      
      .verify-card {
        max-width: 100%;
      }
    }
    
    
    .verify-card-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--fg);
    }
    
    .codeboxes {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin: 1rem 0;
    }
    
    .codeboxes input {
      width: 3ch;
      text-align: center;
      font: 700 1.75rem/1 ui-monospace, monospace;
      padding: 0.75rem 0.25rem;
      border-radius: 0.5rem;
      border: 2px solid var(--border);
      background: var(--bg);
      color: var(--fg);
      transition: border-color 0.2s ease;
    }
    
    .codeboxes input:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    .single-input {
      margin: 1rem 0;
    }
    
    .single-input input {
      width: 100%;
      padding: 0.75rem;
      font-size: 1.1rem;
      text-align: center;
      letter-spacing: 0.1em;
      font-family: ui-monospace, monospace;
      border: 2px solid var(--border);
      border-radius: 0.5rem;
      background: var(--bg);
      color: var(--fg);
      transition: border-color 0.2s ease;
    }
    
    .single-input input:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    .verify-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 1rem;
    }
    
    .verify-status {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-weight: 500;
    }
    
    .verify-status.ok {
      background: var(--success-light);
      color: var(--success);
      border: 1px solid var(--success-border);
    }
    
    .verify-status.err {
      background: var(--danger-light);
      color: var(--danger);
      border: 1px solid var(--danger-border);
    }
    
    .verify-hint {
      font-family: ui-monospace, monospace;
      color: var(--muted);
    }
    
    .camera-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
    }
    
    .verify-video {
      width: 100%;
      border-radius: 0.75rem;
      background: #000;
      /* Flip the video horizontally for easier phone positioning */
      transform: scaleX(-1);
    }
    
    .privacy-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      border-radius: 0.75rem;
      overflow: hidden;
    }
    
    .blur-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      /* Create an ellipse cutout using mask */
      mask: 
        radial-gradient(ellipse 80px 80px at center, transparent 80px, black 80px);
      -webkit-mask: 
        radial-gradient(ellipse 80px 80px at center, transparent 80px, black 80px);
    }
    
    .scanning-blur {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 160px;
      height: 160px;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      background: rgba(255, 255, 255, 0.1);
      pointer-events: none;
    }
    
    .scanning-window {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 160px;
      height: 160px;
      transform: translate(-50%, -50%);
      border: 2px solid rgba(255, 255, 255, 0.8);
      border-radius: 16px;
      background: transparent;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .scanning-text {
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 16px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      white-space: nowrap;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .scanning-corners {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 160px;
      height: 160px;
      transform: translate(-50%, -50%);
    }
    
    .corner {
      position: absolute;
      width: 20px;
      height: 20px;
      border: 3px solid #10b981;
    }
    
    .corner.top-left {
      top: 0;
      left: 0;
      border-right: none;
      border-bottom: none;
    }
    
    .corner.top-right {
      top: 0;
      right: 0;
      border-left: none;
      border-bottom: none;
    }
    
    .corner.bottom-left {
      bottom: 0;
      left: 0;
      border-right: none;
      border-top: none;
    }
    
    .corner.bottom-right {
      bottom: 0;
      right: 0;
      border-left: none;
      border-top: none;
    }
    
    .hidden {
      display: none !important;
    }
    
    .verify-actions {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 0.5rem;
    }
    
    .verify-status {
      text-align: center;
      margin-top: 0.5rem;
    }
    
    canvas {
      display: none;
    }
  </style>
</head>
<body>
  <div class="verify-container">
    <div class="verify-header">
      <div class="verify-pill">ðŸ”’ dpop.fun</div>
      <h1 class="verify-title">Verify the code from your phone</h1>
      <p class="verify-subtitle">Type the code exactly as shown on your phone <span class="verify-hint">(e.g. 8X2J-Q9K3)</span> â€” or switch to camera scan.</p>
    </div>

    <div class="verify-grid">
      <!-- Code entry -->
      <div class="verify-card" id="codeCard" aria-labelledby="codeTitle">
        <h2 id="codeTitle" class="verify-card-title">Enter code</h2>
        <form id="codeForm" autocomplete="one-time-code">
          <div class="codeboxes" id="codeBoxes"></div>
          <div class="single-input hidden" id="singleInputContainer">
            <input type="text" id="singleInput" placeholder="Enter 8-character code (e.g., 8X2J-Q9K3)" maxlength="10" autocomplete="one-time-code">
          </div>
          <div class="verify-actions">
            <button class="btn btn-primary" type="submit">Verify & continue</button>
            <button class="btn btn-secondary" type="button" id="useCamBtn">Use camera instead</button>
            <button class="btn btn-secondary" type="button" id="toggleInputBtn">Single field</button>
          </div>
          <div class="verify-status" id="codeStatus">Code expires ~60s after it appears on your phone.</div>
        </form>
      </div>

      <!-- Camera scan (jsQR) -->
      <div class="verify-card hidden" id="camCard" aria-labelledby="camTitle">
        <h2 id="camTitle" class="verify-card-title">Scan QR from your phone</h2>
        <div class="camera-container">
          <video id="video" class="verify-video" playsinline></video>
          <div class="privacy-overlay">
            <div class="blur-overlay"></div>
            <div class="scanning-blur"></div>
            <div class="scanning-window">
              <div class="scanning-text">Aim QR code here</div>
            </div>
            <div class="scanning-corners">
              <div class="corner top-left"></div>
              <div class="corner top-right"></div>
              <div class="corner bottom-left"></div>
              <div class="corner bottom-right"></div>
            </div>
          </div>
        </div>
        <canvas id="qrCanvas"></canvas>
        <div class="verify-actions" style="margin-top:1rem">
          <button class="btn btn-secondary" id="stopCamBtn" type="button">Use code instead</button>
          <span class="verify-subtitle" id="camHint">Position the QR code within the scanning area.</span>
        </div>
        <div class="verify-status" id="camStatus"></div>
      </div>
    </div>

    <div class="verify-card">
      <strong>Why this step?</strong>
      <p class="verify-subtitle">This page is the only place to enter your code. After verification we cryptographically bind this browser to your session.</p>
    </div>
  </div>

  <!-- Include jsQR (use your existing path or a pinned local copy) -->
  <script src="/public/jsQR.js"></script>
<script>
/** CONFIG **/
const GROUPS = [4,4];                   // 8 chars as 4-4 (or use [5,5] for 10)
const REDEEM_URL = "/device/redeem";    // POST { bc } -> { dpop_nonce, exp }
const FINALIZE_URL = "/link/finalize";  // POST (DPoP) -> 200 session issued
const EXPECTED_QR_PREFIX = "/verify/device?bc="; // phone encodes this

/** DOM refs **/
const $ = s => document.querySelector(s);
const codeBoxesEl = $('#codeBoxes');
const codeStatus = $('#codeStatus');
const camCard = $('#camCard');
const codeCard = $('#codeCard');
const camStatus = $('#camStatus');
const useCamBtn = $('#useCamBtn'), stopCamBtn = $('#stopCamBtn');
const videoEl = $('#video');
const canvasEl = $('#qrCanvas'); const ctx = canvasEl.getContext('2d');
const toggleInputBtn = $('#toggleInputBtn');
const singleInputContainer = $('#singleInputContainer');
const singleInput = $('#singleInput');

/** Build code inputs **/
(function buildInputs(){
  GROUPS.forEach((len, gi)=>{
    for(let i=0;i<len;i++){
      const inp=document.createElement('input');
      inp.inputMode='latin'; inp.maxLength=1; inp.autocomplete='one-time-code';
      
      // Handle individual character input
      inp.addEventListener('input',(e)=>{ 
        e.target.value = normalizeCode(e.target.value).slice(0,1); 
        if(e.target.value && e.target.nextElementSibling) e.target.nextElementSibling.focus();
      });
      
      // Handle paste of full code
      inp.addEventListener('paste',(e)=>{
        e.preventDefault();
        const pastedText = normalizeCode(e.clipboardData.getData('text'));
        if(pastedText.length >= 8) {
          // Fill all inputs with pasted code
          const inputs = codeBoxesEl.querySelectorAll('input');
          for(let j = 0; j < Math.min(pastedText.length, inputs.length); j++) {
            inputs[j].value = pastedText[j];
          }
          // Focus the last input
          inputs[inputs.length - 1].focus();
        }
      });
      
      inp.addEventListener('keydown',(e)=>{ if(e.key==='Backspace'&&!e.target.value&&e.target.previousElementSibling) e.target.previousElementSibling.focus();});
      codeBoxesEl.appendChild(inp);
    }
    if(gi < GROUPS.length-1){ const spacer=document.createElement('div'); spacer.style.width='0.75rem'; codeBoxesEl.appendChild(spacer); }
  });
  codeBoxesEl.querySelector('input')?.focus();
})();

function normalizeCode(raw){
  return raw.toUpperCase().replace(/[^A-Z2-9]/g,'').replace(/[ILOU]/g,(c)=>({I:'1',L:'1',O:'0',U:'V'}[c]||c));
}
function joinGroups(inputs){ return [...inputs].map(i=>i.value).join(''); }

/** Toggle between individual boxes and single input **/
let useSingleInput = false;
toggleInputBtn.addEventListener('click', () => {
  useSingleInput = !useSingleInput;
  if (useSingleInput) {
    codeBoxesEl.classList.add('hidden');
    singleInputContainer.classList.remove('hidden');
    toggleInputBtn.textContent = 'Individual boxes';
    singleInput.focus();
  } else {
    codeBoxesEl.classList.remove('hidden');
    singleInputContainer.classList.add('hidden');
    toggleInputBtn.textContent = 'Single field';
    codeBoxesEl.querySelector('input')?.focus();
  }
});

/** Handle single input **/
singleInput.addEventListener('input', (e) => {
  e.target.value = normalizeCode(e.target.value);
});

/** Get current code from either input method **/
function getCurrentCode() {
  if (useSingleInput) {
    return normalizeCode(singleInput.value);
  } else {
    return joinGroups(codeBoxesEl.querySelectorAll('input'));
  }
}

/** DPoP key - generate new key for verify page **/
let dpopKeyPair;
async function ensureDpopKey(){
  if(dpopKeyPair) return dpopKeyPair;
  
  // Generate new DPoP key for verify page
  // The server will allow this key to be bound to the session
  dpopKeyPair = await crypto.subtle.generateKey({name:"ECDSA", namedCurve:"P-256"}, false, ["sign","verify"]);
  console.log('Generated new DPoP key for verify page');
  return dpopKeyPair;
}

async function exportJwk(pub){ return crypto.subtle.exportKey("jwk", pub); }
function b64u(buf){ const b = typeof buf==='string'? new TextEncoder().encode(buf): new Uint8Array(buf); return btoa(String.fromCharCode(...b)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
async function signES256(priv, bytes){ const sig = await crypto.subtle.sign({name:"ECDSA", hash:"SHA-256"}, priv, bytes); return b64u(sig); }
async function makeDpopProof(url, method, nonce){
  const now = Math.floor(Date.now()/1000);
  const {privateKey, publicKey} = await ensureDpopKey();
  const jwk = await exportJwk(publicKey);
  const hdr = b64u(JSON.stringify({alg:"ES256", typ:"dpop+jwt", jwk}));
  const pld = b64u(JSON.stringify({htu:url, htm:method, iat:now, jti:crypto.randomUUID(), nonce}));
  const toSign = new TextEncoder().encode(`${hdr}.${pld}`);
  const sig = await signES256(privateKey, toSign);
  return `${hdr}.${pld}.${sig}`;
}

/** Submit code path **/
$('#codeForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const bc = getCurrentCode();
  if (bc.length !== GROUPS.reduce((a,b)=>a+b,0)) {
    codeStatus.textContent = "Please enter the full code."; codeStatus.className = "status err"; return;
  }
  try{
    codeStatus.textContent = "Verifying codeâ€¦"; codeStatus.className = "status";
    const redeem = await fetch(REDEEM_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ bc }) });
    if(!redeem.ok){ throw new Error(await redeem.text() || "Code rejected"); }
    const { dpop_nonce, link_id } = await redeem.json();

    const finalizeUrl = new URL(FINALIZE_URL, location.origin).toString();
    const proof = await makeDpopProof(finalizeUrl, "POST", dpop_nonce);
    const fin = await fetch(FINALIZE_URL, { method:"POST", headers:{ "Authorization":"DPoP placeholder", "DPoP": proof }});
    if(!fin.ok){ throw new Error(await fin.text() || "Finalize failed"); }

    codeStatus.textContent = "Success. Securing your sessionâ€¦"; codeStatus.className = "status ok";
    setTimeout(()=>location.assign(`/app?lid=${link_id}`), 300);
  }catch(err){
    codeStatus.textContent = `Error: ${String(err.message||err)}`; codeStatus.className = "status err";
  }
});

/** Camera scan using jsQR **/
let stream, stopLoop;
async function startCam(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode:'environment', 
        width:{ideal:1280}, 
        height:{ideal:720} 
      } 
    });
  }catch(e){
    camStatus.textContent = "Camera permission denied or unavailable."; camStatus.className = "status err"; return;
  }
  videoEl.srcObject = stream; 
  await videoEl.play();
  camStatus.textContent = "Scanningâ€¦"; camStatus.className = "status";

  const loop = async () => {
    if (stopLoop) return;
    // Downscale for speed; keep aspect
    const vw = videoEl.videoWidth || 640, vh = videoEl.videoHeight || 480;
    const scale = Math.min(640 / vw, 480 / vh, 1);
    const w = Math.max(320, Math.floor(vw * scale));
    const h = Math.max(240, Math.floor(vh * scale));
    canvasEl.width = w; canvasEl.height = h;
    
    // Flip the image horizontally for easier phone positioning
    ctx.save();
    ctx.scale(-1, 1);
    ctx.drawImage(videoEl, -w, 0, w, h);
    ctx.restore();
    
    const img = ctx.getImageData(0, 0, w, h);

    const result = jsQR(img.data, w, h, { 
      // Try multiple inversion attempts for better detection
      inversionAttempts: "attemptBoth"
    });
    
    if (result && result.data) {
      const text = (result.data + '').trim();
      console.log('QR detected:', text); // Debug log
      
      // Check for the expected prefix (more flexible matching)
      if (text.includes('/verify/device?bc=') || text.startsWith(EXPECTED_QR_PREFIX)) {
        let bcRaw;
        if (text.includes('/verify/device?bc=')) {
          bcRaw = text.split('/verify/device?bc=')[1];
        } else {
          bcRaw = text.slice(EXPECTED_QR_PREFIX.length);
        }
        
        console.log('BC code extracted:', bcRaw); // Debug log
        autofillAndSubmit(bcRaw);
        stopCam(); 
        return;
      } else {
        console.log('QR code not matching expected format:', text); // Debug log
        // ignore foreign QR codes; keep scanning
      }
    }
    
    if ('requestVideoFrameCallback' in HTMLVideoElement.prototype){
      videoEl.requestVideoFrameCallback(loop);
    } else {
      requestAnimationFrame(loop);
    }
  };
  
  stopLoop = false;
  if ('requestVideoFrameCallback' in HTMLVideoElement.prototype){
    videoEl.requestVideoFrameCallback(loop);
  } else {
    requestAnimationFrame(loop);
  }
}
function autofillAndSubmit(code){
  const norm = normalizeCode(code);
  const inputs = codeBoxesEl.querySelectorAll('input');
  let i=0; for (const ch of norm) { if (i<inputs.length) { inputs[i++].value = ch; } }
  $('#codeForm').requestSubmit();
}
function stopCam(){
  stopLoop = true;
  if (stream) { stream.getTracks().forEach(t=>t.stop()); stream = null; }
}

useCamBtn.addEventListener('click', async ()=>{
  codeCard.classList.add('hidden'); camCard.classList.remove('hidden');
  await startCam();
});
stopCamBtn.addEventListener('click', ()=>{
  stopCam(); camCard.classList.add('hidden'); codeCard.classList.remove('hidden');
});
</script>
</body>
</html>
