<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Verify your sign-in â€¢ verify.example.com</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-eval'; frame-ancestors 'none'; base-uri 'none'">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta name="color-scheme" content="light dark">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --fg:#111; --muted:#666; --ok:#0a7; --warn:#e67; --bg:#fff; --card:#f7f7f8; }
    @media (prefers-color-scheme: dark){ :root{ --fg:#eee; --muted:#aaa; --ok:#29e; --warn:#f66; --bg:#111; --card:#1a1a1d;}}
    body{margin:0; font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    .wrap{max-width:720px; margin:40px auto; padding:0 16px; color:var(--fg); background:var(--bg)}
    .pill{display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .7rem; border-radius:999px; background:var(--card); font-family:ui-monospace,monospace}
    h1{font-size:1.5rem; margin:12px 0 8px}
    .muted{color:var(--muted)}
    .card{background:var(--card); border-radius:14px; padding:16px; margin:16px 0}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    @media (max-width:800px){ .grid{grid-template-columns:1fr}}
    .codeboxes{display:flex; gap:.5rem; justify-content:center; margin:12px 0}
    .codeboxes input{width:2.6ch; text-align:center; font:700 28px/1 ui-monospace,monospace; padding:.35rem .1rem; border-radius:8px; border:1px solid #ccc; background:#fff}
    @media (prefers-color-scheme: dark){ .codeboxes input{background:#111; border-color:#333; color:var(--fg)} }
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.6rem .9rem; border-radius:10px; border:0; background:var(--fg); color:var(--bg); cursor:pointer; font-weight:600}
    .btn.sec{background:transparent; color:var(--fg); border:1px solid #666}
    .row{display:flex; gap:.75rem; flex-wrap:wrap; align-items:center}
    .hint{font-family:ui-monospace,monospace}
    .status{margin-top:8px}
    .status.ok{color:var(--ok)} .status.err{color:var(--warn)}
    video{width:100%; border-radius:12px; background:#000}
    .hidden{display:none !important}
    canvas{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="pill">ðŸ”’ verify.example.com</div>
    <h1>Verify the code from your phone</h1>
    <p class="muted">Type the code exactly as shown on your phone <span class="hint">(e.g. 8X2J-Q9K3)</span> â€” or switch to camera scan.</p>

    <div class="grid">
      <!-- Code entry -->
      <div class="card" id="codeCard" aria-labelledby="codeTitle">
        <h2 id="codeTitle">Enter code</h2>
        <form id="codeForm" autocomplete="one-time-code">
          <div class="codeboxes" id="codeBoxes"></div>
          <div class="row">
            <button class="btn" type="submit">Verify & continue</button>
            <button class="btn sec" type="button" id="useCamBtn">Use camera instead</button>
          </div>
          <div class="status muted" id="codeStatus">Code expires ~60s after it appears on your phone.</div>
        </form>
      </div>

      <!-- Camera scan (jsQR) -->
      <div class="card hidden" id="camCard" aria-labelledby="camTitle">
        <h2 id="camTitle">Scan QR from your phone</h2>
        <video id="video" playsinline></video>
        <canvas id="qrCanvas"></canvas>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="stopCamBtn" type="button">Use code instead</button>
          <span class="muted" id="camHint">Point the camera at the QR shown on your phone.</span>
        </div>
        <div class="status" id="camStatus"></div>
      </div>
    </div>

    <div class="card">
      <strong>Why this step?</strong>
      <p class="muted">This page is the only place to enter your code. After verification we cryptographically bind this browser to your session.</p>
    </div>
  </div>

  <!-- Include jsQR (use your existing path or a pinned local copy) -->
  <script src="/public/jsQR.min.js"></script>
<script>
/** CONFIG **/
const GROUPS = [4,4];                   // 8 chars as 4-4 (or use [5,5] for 10)
const REDEEM_URL = "/device/redeem";    // POST { bc } -> { dpop_nonce, exp }
const FINALIZE_URL = "/link/finalize";  // POST (DPoP) -> 200 session issued
const EXPECTED_QR_PREFIX = "https://verify.example.com/device?bc="; // phone encodes this

/** DOM refs **/
const $ = s => document.querySelector(s);
const codeBoxesEl = $('#codeBoxes');
const codeStatus = $('#codeStatus');
const camCard = $('#camCard');
const codeCard = $('#codeCard');
const camStatus = $('#camStatus');
const useCamBtn = $('#useCamBtn'), stopCamBtn = $('#stopCamBtn');
const videoEl = $('#video');
const canvasEl = $('#qrCanvas'); const ctx = canvasEl.getContext('2d');

/** Build code inputs **/
(function buildInputs(){
  GROUPS.forEach((len, gi)=>{
    for(let i=0;i<len;i++){
      const inp=document.createElement('input');
      inp.inputMode='latin'; inp.maxLength=1; inp.autocomplete='one-time-code';
      inp.addEventListener('input',(e)=>{ e.target.value = normalizeCode(e.target.value).slice(0,1); if(e.target.value && e.target.nextElementSibling) e.target.nextElementSibling.focus();});
      inp.addEventListener('keydown',(e)=>{ if(e.key==='Backspace'&&!e.target.value&&e.target.previousElementSibling) e.target.previousElementSibling.focus();});
      codeBoxesEl.appendChild(inp);
    }
    if(gi < GROUPS.length-1){ const spacer=document.createElement('div'); spacer.style.width='0.75rem'; codeBoxesEl.appendChild(spacer); }
  });
  codeBoxesEl.querySelector('input')?.focus();
})();

function normalizeCode(raw){
  return raw.toUpperCase().replace(/[^A-Z2-9]/g,'').replace(/[ILOU]/g,(c)=>({I:'1',L:'1',O:'0',U:'V'}[c]||c));
}
function joinGroups(inputs){ return [...inputs].map(i=>i.value).join(''); }

/** DPoP key (memory-only example; persist if policy allows) **/
let dpopKeyPair;
async function ensureDpopKey(){
  if(dpopKeyPair) return dpopKeyPair;
  dpopKeyPair = await crypto.subtle.generateKey({name:"ECDSA", namedCurve:"P-256"}, false, ["sign","verify"]);
  return dpopKeyPair;
}
async function exportJwk(pub){ return crypto.subtle.exportKey("jwk", pub); }
function b64u(buf){ const b = typeof buf==='string'? new TextEncoder().encode(buf): new Uint8Array(buf); return btoa(String.fromCharCode(...b)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
async function signES256(priv, bytes){ const sig = await crypto.subtle.sign({name:"ECDSA", hash:"SHA-256"}, priv, bytes); return b64u(sig); }
async function makeDpopProof(url, method, nonce){
  const now = Math.floor(Date.now()/1000);
  const {privateKey, publicKey} = await ensureDpopKey();
  const jwk = await exportJwk(publicKey);
  const hdr = b64u(JSON.stringify({alg:"ES256", typ:"dpop+jwt", jwk}));
  const pld = b64u(JSON.stringify({htu:url, htm:method, iat:now, jti:crypto.randomUUID(), nonce}));
  const toSign = new TextEncoder().encode(`${hdr}.${pld}`);
  const sig = await signES256(privateKey, toSign);
  return `${hdr}.${pld}.${sig}`;
}

/** Submit code path **/
$('#codeForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const raw = joinGroups(codeBoxesEl.querySelectorAll('input'));
  const bc = normalizeCode(raw);
  if (bc.length !== GROUPS.reduce((a,b)=>a+b,0)) {
    codeStatus.textContent = "Please enter the full code."; codeStatus.className = "status err"; return;
  }
  try{
    codeStatus.textContent = "Verifying codeâ€¦"; codeStatus.className = "status";
    const redeem = await fetch(REDEEM_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ bc }) });
    if(!redeem.ok){ throw new Error(await redeem.text() || "Code rejected"); }
    const { dpop_nonce } = await redeem.json();

    const finalizeUrl = new URL(FINALIZE_URL, location.origin).toString();
    const proof = await makeDpopProof(finalizeUrl, "POST", dpop_nonce);
    const fin = await fetch(FINALIZE_URL, { method:"POST", headers:{ "Authorization":"DPoP placeholder", "DPoP": proof }});
    if(!fin.ok){ throw new Error(await fin.text() || "Finalize failed"); }

    codeStatus.textContent = "Success. Securing your sessionâ€¦"; codeStatus.className = "status ok";
    setTimeout(()=>location.assign("/app"), 300);
  }catch(err){
    codeStatus.textContent = `Error: ${String(err.message||err)}`; codeStatus.className = "status err";
  }
});

/** Camera scan using jsQR **/
let stream, stopLoop;
async function startCam(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }});
  }catch(e){
    camStatus.textContent = "Camera permission denied or unavailable."; camStatus.className = "status err"; return;
  }
  videoEl.srcObject = stream; await videoEl.play();
  camStatus.textContent = "Scanningâ€¦"; camStatus.className = "status";

  const loop = async () => {
    if (stopLoop) return;
    // Downscale for speed; keep aspect
    const vw = videoEl.videoWidth || 640, vh = videoEl.videoHeight || 480;
    const scale = Math.min(640 / vw, 480 / vh, 1);
    const w = Math.max(320, Math.floor(vw * scale));
    const h = Math.max(240, Math.floor(vh * scale));
    canvasEl.width = w; canvasEl.height = h;
    ctx.drawImage(videoEl, 0, 0, w, h);
    const img = ctx.getImageData(0, 0, w, h);

    const result = jsQR(img.data, w, h, { inversionAttempts: "dontInvert" });
    if (result && result.data) {
      const text = (result.data + '').trim();
      if (text.startsWith(EXPECTED_QR_PREFIX)) {
        const bcRaw = text.slice(EXPECTED_QR_PREFIX.length);
        autofillAndSubmit(bcRaw);
        stopCam(); return;
      } else {
        // ignore foreign QR codes; keep scanning
      }
    }
    if ('requestVideoFrameCallback' in HTMLVideoElement.prototype){
      videoEl.requestVideoFrameCallback(loop);
    } else {
      requestAnimationFrame(loop);
    }
  };
  stopLoop = false;
  if ('requestVideoFrameCallback' in HTMLVideoElement.prototype){
    videoEl.requestVideoFrameCallback(loop);
  } else {
    requestAnimationFrame(loop);
  }
}
function autofillAndSubmit(code){
  const norm = normalizeCode(code);
  const inputs = codeBoxesEl.querySelectorAll('input');
  let i=0; for (const ch of norm) { if (i<inputs.length) { inputs[i++].value = ch; } }
  $('#codeForm').requestSubmit();
}
function stopCam(){
  stopLoop = true;
  if (stream) { stream.getTracks().forEach(t=>t.stop()); stream = null; }
}

useCamBtn.addEventListener('click', async ()=>{
  codeCard.classList.add('hidden'); camCard.classList.remove('hidden');
  await startCam();
});
stopCamBtn.addEventListener('click', ()=>{
  stopCam(); camCard.classList.add('hidden'); codeCard.classList.remove('hidden');
});
</script>
</body>
</html>
