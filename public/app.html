<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Linked Successfully ‚Ä¢ dpop.fun</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; base-uri 'none'">
    <link rel="stylesheet" href="/public/style.css">
    <style>
        body {
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .app-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .success-container {
            text-align: center;
            width: 100%;
            max-width: 500px;
            margin-bottom: 2rem;
        }
        
        .success-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--ok);
        }
        
        .success-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--fg);
        }
        
        .success-message {
            color: var(--muted);
            margin-bottom: 2rem;
            line-height: 1.5;
        }
        
        .success-details {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: left;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .detail-row:last-child {
            margin-bottom: 0;
        }
        
        .detail-label {
            color: var(--muted);
            font-size: 0.9rem;
        }
        
        .detail-value {
            font-family: ui-monospace, monospace;
            font-size: 0.9rem;
            color: var(--fg);
        }
        
        .actions {
            display: flex;
            justify-content: center;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn.primary {
            background: var(--ok);
            color: white;
        }
        
        .btn.primary:hover {
            background: var(--ok-hover);
        }
        
        .btn.on {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }
        
        .btn.on:hover {
            background: #059669;
        }
        
        .btn.kill {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
        
        .btn.kill:hover {
            background: #b91c1c;
        }
        
        .fingerprint-summary {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .fingerprint-loading {
            color: var(--fg-muted);
            font-style: italic;
        }
        
        .fingerprint-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        .fingerprint-item:last-child {
            border-bottom: none;
        }
        
        .fingerprint-label {
            font-weight: 500;
            color: var(--fg);
        }
        
        .fingerprint-value {
            color: var(--fg-muted);
            font-family: ui-monospace, monospace;
            font-size: 0.9rem;
            max-width: 60%;
            text-align: right;
            word-break: break-all;
        }
        
        .fingerprint-category {
            margin-top: 1rem;
        }
        
        .fingerprint-category:first-child {
            margin-top: 0;
        }
        
        .fingerprint-category-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .btn.secondary {
            background: var(--card);
            color: var(--fg);
            border: 1px solid var(--border);
        }
        
        .btn.secondary:hover {
            background: var(--hover);
        }
        
        /* Scribble Section Styles */
        .scribble-section {
            width: 100%;
            max-width: 500px;
            padding: 1.5rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            text-align: center;
        }
        
        .scribble-section h3 {
            margin: 0 0 0.5rem 0;
            color: var(--fg);
            font-size: 1.25rem;
        }
        
        .scribble-description {
            color: var(--muted);
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }
        
        .signature-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            width: 100%;
            overflow: hidden;
        }
        
        #signature-canvas-desktop-canvas {
            max-width: 100%;
            height: auto;
            border: 2px solid var(--border) !important;
            border-radius: 8px;
            background: white;
        }
        
        .scribble-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }
        
        .status-indicator {
            font-size: 1rem;
            color: var(--muted);
        }
        
        .status-indicator.connected {
            color: var(--ok);
        }
        
        .status-indicator.error {
            color: var(--error);
        }
        
        .status-text {
            color: var(--muted);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="success-container">
            <div class="success-icon">‚úÖ</div>
            <h1 class="success-title">Device Successfully Linked!</h1>
            <p class="success-message">
                Your mobile device has been successfully linked to this desktop session. 
                You can now use your mobile device for secure authentication.
            </p>
            
            <div class="success-details">
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">Linked & Verified</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Linked At:</span>
                    <span class="detail-value" id="linkedAt">Loading...</span>
                </div>
                <div class="detail-row" style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button class="btn secondary" onclick="window.location.href='/face-verify'">Face Verification</button>
                    <button class="btn on" onclick="window.location.href='/'">Back to Start</button>
                    <button class="btn kill" onclick="console.log('Kill button clicked'); killSession()">Kill Session</button>
                </div>
            </div>
            
            <!-- Desktop Device Fingerprint Summary -->
            <div class="success-container">
                <h3>üñ•Ô∏è Desktop Device Fingerprint</h3>
                <div class="fingerprint-summary" id="desktopFingerprintSummary">
                    <div class="fingerprint-loading">Loading desktop fingerprint data...</div>
                </div>
            </div>
            
            <!-- Mobile Device Fingerprint Summary -->
            <div class="success-container">
                <h3>üì± Mobile Device Fingerprint</h3>
                <div class="fingerprint-summary" id="mobileFingerprintSummary">
                    <div class="fingerprint-loading">Loading mobile fingerprint data...</div>
                </div>
            </div>
            
        </div>
        
        <!-- Scribble Section -->
        <div class="scribble-section">
            <h3>üìù Live Scribble from Mobile</h3>
            <p class="scribble-description">
                Draw on your mobile device to see it appear here in real-time!
            </p>
            <div id="signature-canvas-desktop" class="signature-container">
                <canvas id="signature-canvas-desktop-canvas" width="400" height="300"></canvas>
            </div>
            <div class="scribble-status" id="scribbleStatus">
                <span class="status-indicator">‚óè</span>
                <span class="status-text">Waiting for mobile connection...</span>
            </div>
        </div>
    </div>

    <script type="module">
        // Get session info from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const linkId = urlParams.get('lid') || urlParams.get('linkId') || null;
        const linkedAt = new Date().toLocaleString();
        
        document.getElementById('linkedAt').textContent = linkedAt;
        
        // Load and display fingerprint data for both desktop and mobile
        loadFingerprintData();
        
        
        // Global function for killing session
        window.killSession = async function() {
            console.log('killSession function called');
            if (confirm('Are you sure you want to kill this session? This will terminate the connection completely.')) {
                try {
                    // Close any WebSocket connections
                    if (window.signatureShare && window.signatureShare.websocket) {
                        window.signatureShare.websocket.close();
                    }
                    
                    // Call server endpoint to kill the session
                    const response = await fetch('/session/kill', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        alert('Session killed successfully. Redirecting to home page.');
                        window.location.href = '/';
                    } else {
                        alert('Failed to kill session. Please try again.');
                    }
                } catch (error) {
                    console.error('Error killing session:', error);
                    alert('Error killing session. Please try again.');
                }
            }
        };
        
        async function collectAndDisplayFingerprint() {
            try {
                console.log('üîç Collecting fingerprint data for /app page...');
                
                // Collect fingerprint data
                const fingerprint = {
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`,
                    colorDepth: screen.colorDepth,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: navigator.language,
                    platform: navigator.platform,
                    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                    deviceMemory: navigator.deviceMemory || 'unknown',
                    cookieEnabled: navigator.cookieEnabled,
                    doNotTrack: navigator.doNotTrack || 'unknown',
                    webglVendor: getWebGLVendor(),
                    webglRenderer: getWebGLRenderer(),
                    canvasFingerprint: getCanvasFingerprint() || 'unknown',
                    audioFingerprint: 'skipped', // Skip audio fingerprinting for now
                    timestamp: new Date().toISOString()
                };
                
                console.log('üìä Fingerprint data collected:', fingerprint);
                
                // Send fingerprint data to server
                const response = await fetch('/session/fingerprint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(fingerprint)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to store fingerprint: ${response.status} ${errorText}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ Fingerprint stored successfully:', result);
                
                // Now display the fingerprint data
                displayFingerprintData(fingerprint);
                
            } catch (error) {
                console.error('‚ùå Failed to collect fingerprint:', error);
                document.getElementById('fingerprintSummary').innerHTML = 
                    '<div class="fingerprint-loading">Failed to collect fingerprint data: ' + error.message + '</div>';
            }
        }
        
        function getWebGLVendor() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return 'unknown';
                
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                if (!debugInfo) return 'unknown';
                
                return gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
            } catch (e) {
                return 'unknown';
            }
        }
        
        function getWebGLRenderer() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return 'unknown';
                
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                if (!debugInfo) return 'unknown';
                
                return gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
            } catch (e) {
                return 'unknown';
            }
        }
        
        function getCanvasFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Draw some text and shapes
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillStyle = '#f60';
                ctx.fillRect(125, 1, 62, 20);
                ctx.fillStyle = '#069';
                ctx.fillText('Canvas fingerprint', 2, 15);
                ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                ctx.fillText('Canvas fingerprint', 4, 17);
                
                return canvas.toDataURL();
            } catch (e) {
                return 'unknown';
            }
        }
        
        async function loadFingerprintData() {
            try {
                console.log('Loading fingerprint data for both desktop and mobile...');
                console.log('Available cookies:', document.cookie);
                console.log('Current URL:', window.location.href);
                const response = await fetch('/session/fingerprint-data', {
                    credentials: 'include'
                });
                
                console.log('Fingerprint response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Fingerprint response error:', errorText);
                    throw new Error(`Failed to load fingerprint data: ${response.status} ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Fingerprint data received:', data);
                
                // Load desktop fingerprint
                const desktopFingerprint = data.desktop.fingerprint;
                const desktopDeviceType = data.desktop.device_type || 'unknown';
                console.log('Desktop fingerprint object:', desktopFingerprint);
                console.log('Desktop device type:', desktopDeviceType);
                
                if (!desktopFingerprint || Object.keys(desktopFingerprint).length === 0) {
                    console.log('No desktop fingerprint data available');
                    document.getElementById('desktopFingerprintSummary').innerHTML = 
                        '<div class="fingerprint-loading">No desktop fingerprint data available</div>';
                } else {
                    console.log('Displaying desktop fingerprint data:', desktopFingerprint);
                    displayFingerprintData(desktopFingerprint, desktopDeviceType, 'desktopFingerprintSummary');
                }
                
                // Load mobile fingerprint
                const mobileFingerprint = data.mobile.fingerprint;
                const mobileDeviceType = data.mobile.device_type || 'unknown';
                const mobileLinked = data.mobile.linked;
                console.log('Mobile fingerprint object:', mobileFingerprint);
                console.log('Mobile device type:', mobileDeviceType);
                console.log('Mobile linked:', mobileLinked);
                
                if (!mobileLinked) {
                    console.log('No mobile session linked');
                    document.getElementById('mobileFingerprintSummary').innerHTML = 
                        '<div class="fingerprint-loading">No mobile session linked yet</div>';
                } else if (!mobileFingerprint || Object.keys(mobileFingerprint).length === 0) {
                    console.log('No mobile fingerprint data available');
                    document.getElementById('mobileFingerprintSummary').innerHTML = 
                        '<div class="fingerprint-loading">No mobile fingerprint data available</div>';
                } else {
                    console.log('Displaying mobile fingerprint data:', mobileFingerprint);
                    displayFingerprintData(mobileFingerprint, mobileDeviceType, 'mobileFingerprintSummary');
                }
                
            } catch (error) {
                console.error('Failed to load fingerprint data:', error);
                document.getElementById('desktopFingerprintSummary').innerHTML = 
                    '<div class="fingerprint-loading">Failed to load desktop fingerprint data: ' + error.message + '</div>';
                document.getElementById('mobileFingerprintSummary').innerHTML = 
                    '<div class="fingerprint-loading">Failed to load mobile fingerprint data: ' + error.message + '</div>';
            }
        }
        
        
        function displayFingerprintData(fingerprint, deviceType = 'unknown', targetElementId = 'fingerprintSummary') {
            console.log('displayFingerprintData called with:', fingerprint, 'deviceType:', deviceType, 'targetElementId:', targetElementId);
            const summaryEl = document.getElementById(targetElementId);
            
            const deviceInfo = {
                'Device Type': deviceType.charAt(0).toUpperCase() + deviceType.slice(1),
                'User Agent': fingerprint.userAgent || 'Unknown',
                'Screen Resolution': fingerprint.screenResolution || 'Unknown',
                'Color Depth': fingerprint.colorDepth || 'Unknown',
                'Platform': fingerprint.platform || 'Unknown',
                'Language': fingerprint.language || 'Unknown',
                'Timezone': fingerprint.timezone || 'Unknown',
                'Hardware Concurrency': fingerprint.hardwareConcurrency || 'Unknown',
                'Device Memory': fingerprint.deviceMemory || 'Unknown',
                'Cookie Enabled': fingerprint.cookieEnabled ? 'Yes' : 'No',
                'Do Not Track': fingerprint.doNotTrack || 'Unknown'
            };
            
            console.log('deviceInfo:', deviceInfo);
            
            const graphicsInfo = {
                'WebGL Vendor': fingerprint.webglVendor || 'Unknown',
                'WebGL Renderer': fingerprint.webglRenderer || 'Unknown'
            };
            
            const uaChInfo = fingerprint.ua_ch ? {
                'Mobile Device': fingerprint.ua_ch.mobile ? 'Yes' : 'No',
                'Platform': fingerprint.ua_ch.platform || 'Unknown',
                'Platform Version': fingerprint.ua_ch.platformVersion || 'Unknown',
                'Architecture': fingerprint.ua_ch.architecture || 'Unknown',
                'Model': fingerprint.ua_ch.model || 'Unknown',
                'Browser Version': fingerprint.ua_ch.uaFullVersion || 'Unknown',
                'Bitness': fingerprint.ua_ch.bitness || 'Unknown',
                'Full Version List': fingerprint.ua_ch.fullVersionList ? fingerprint.ua_ch.fullVersionList.map(v => `${v.brand}:${v.version}`).join(', ') : 'Unknown'
            } : {
                'User Agent Client Hints': 'Not Available'
            };
            
            const automationInfo = fingerprint.automation ? {
                'WebDriver Present': fingerprint.automation.webdriver ? 'Yes' : 'No',
                'Headless Chrome': fingerprint.automation.headlessUA ? 'Yes' : 'No',
                'Plugins Count': fingerprint.automation.pluginsLength || 'Unknown',
                'MIME Types Count': fingerprint.automation.mimeTypesLength || 'Unknown',
                'Visibility State': fingerprint.automation.visibilityState || 'Unknown',
                'Has Focus': fingerprint.automation.hasFocus ? 'Yes' : 'No',
                'Permissions': fingerprint.automation.permissionsAnomalies ? 
                    Object.entries(fingerprint.automation.permissionsAnomalies).map(([k,v]) => `${k}: ${v}`).join(', ') : 'Unknown'
            } : {
                'Automation Detection': 'Not Available'
            };
            
            const networkInfo = {
                'IP Address': fingerprint.ip_address || 'Unknown',
                'Collection Time': fingerprint.timestamp ? new Date(fingerprint.timestamp).toLocaleString() : 'Unknown'
            };
            
            const geolocationInfo = fingerprint.geolocation ? {
                'City': fingerprint.geolocation.city || 'Unknown',
                'Region': fingerprint.geolocation.region || 'Unknown',
                'Country': fingerprint.geolocation.country || 'Unknown',
                'Country Code': fingerprint.geolocation.country_code || 'Unknown',
                'Postal Code': fingerprint.geolocation.postal || 'Unknown',
                'Coordinates': `${fingerprint.geolocation.latitude}, ${fingerprint.geolocation.longitude}`,
                'Timezone': fingerprint.geolocation.timezone || 'Unknown',
                'Organization': fingerprint.geolocation.org || 'Unknown',
                'ASN': fingerprint.geolocation.asn || 'Unknown'
            } : {
                'Geolocation': 'Not Available'
            };
            
            let html = '';
            
            // Device Information
            html += '<div class="fingerprint-category">';
            html += '<div class="fingerprint-category-title">Device Information</div>';
            for (const [label, value] of Object.entries(deviceInfo)) {
                html += `<div class="fingerprint-item">
                    <span class="fingerprint-label">${label}:</span>
                    <span class="fingerprint-value">${value}</span>
                </div>`;
            }
            html += '</div>';
            
            // Graphics Information
            html += '<div class="fingerprint-category">';
            html += '<div class="fingerprint-category-title">Graphics</div>';
            for (const [label, value] of Object.entries(graphicsInfo)) {
                html += `<div class="fingerprint-item">
                    <span class="fingerprint-label">${label}:</span>
                    <span class="fingerprint-value">${value}</span>
                </div>`;
            }
            html += '</div>';
            
            // User Agent Client Hints Information
            html += '<div class="fingerprint-category">';
            html += '<div class="fingerprint-category-title">User Agent Client Hints</div>';
            for (const [label, value] of Object.entries(uaChInfo)) {
                html += `<div class="fingerprint-item">
                    <span class="fingerprint-label">${label}:</span>
                    <span class="fingerprint-value">${value}</span>
                </div>`;
            }
            html += '</div>';
            
            // Automation Detection Information
            html += '<div class="fingerprint-category">';
            html += '<div class="fingerprint-category-title">Automation Detection</div>';
            for (const [label, value] of Object.entries(automationInfo)) {
                html += `<div class="fingerprint-item">
                    <span class="fingerprint-label">${label}:</span>
                    <span class="fingerprint-value">${value}</span>
                </div>`;
            }
            html += '</div>';
            
            // Network Information
            html += '<div class="fingerprint-category">';
            html += '<div class="fingerprint-category-title">Network Information</div>';
            for (const [label, value] of Object.entries(networkInfo)) {
                html += `<div class="fingerprint-item">
                    <span class="fingerprint-label">${label}:</span>
                    <span class="fingerprint-value">${value}</span>
                </div>`;
            }
            html += '</div>';
            
            // Geolocation Information
            html += '<div class="fingerprint-category">';
            html += '<div class="fingerprint-category-title">Geolocation</div>';
            for (const [label, value] of Object.entries(geolocationInfo)) {
                html += `<div class="fingerprint-item">
                    <span class="fingerprint-label">${label}:</span>
                    <span class="fingerprint-value">${value}</span>
                </div>`;
            }
            html += '</div>';
            
            console.log('Generated HTML:', html);
            summaryEl.innerHTML = html;
        }
        
        // Initialize signature sharing if linkId is available
        if (linkId) {
            initializeSignatureSharing(linkId);
        } else {
            updateScribbleStatus('No link ID provided', 'error');
        }
        
        // Auto-close after 10 seconds if opened in popup
        if (window.opener) {
            setTimeout(() => {
                window.close();
            }, 10000);
        }
        
        async function initializeSignatureSharing(linkId) {
            try {
                updateScribbleStatus('Connecting to mobile device...', 'connecting');
                
                // Import and initialize signature sharing
                const { SignatureShare } = await import('/src/signature-share.js');
                const signatureShare = new SignatureShare();
                
                // Initialize for desktop (viewing)
                signatureShare.initDesktop(linkId);
                
                // Set up WebSocket connection monitoring
                monitorWebSocketConnection(signatureShare);
                
                updateScribbleStatus('Connected! Draw on your mobile device to see it here.', 'connected');
                
            } catch (error) {
                console.error('Failed to initialize signature sharing:', error);
                updateScribbleStatus('Failed to connect to mobile device', 'error');
            }
        }
        
        function monitorWebSocketConnection(signatureShare) {
            // Monitor WebSocket connection status
            const checkConnection = () => {
                if (signatureShare.websocket) {
                    if (signatureShare.websocket.readyState === WebSocket.OPEN) {
                        updateScribbleStatus('Connected! Draw on your mobile device to see it here.', 'connected');
                    } else if (signatureShare.websocket.readyState === WebSocket.CONNECTING) {
                        updateScribbleStatus('Connecting to mobile device...', 'connecting');
                    } else {
                        updateScribbleStatus('Connection lost. Mobile device may have disconnected.', 'error');
                    }
                }
            };
            
            // Check connection status every 2 seconds
            setInterval(checkConnection, 2000);
        }
        
        function updateScribbleStatus(message, status) {
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = document.querySelector('.status-text');
            
            if (statusIndicator && statusText) {
                statusText.textContent = message;
                
                // Update indicator color based on status
                statusIndicator.className = 'status-indicator';
                if (status === 'connected') {
                    statusIndicator.classList.add('connected');
                } else if (status === 'error') {
                    statusIndicator.classList.add('error');
                }
            }
        }
        
    </script>
</body>
</html>
