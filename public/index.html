<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔐 Browser Identity & DPoP Security Demo</title>
    <link rel="icon" type="image/x-icon" href="/public/favicon.ico">
    <link rel="stylesheet" href="/public/css/design-system.css">
    <link rel="stylesheet" href="/public/css/components.css">
    <link rel="stylesheet" href="/public/css/notifications.css">
    <link rel="stylesheet" href="/public/style.css">

</head>
<body>
    <!-- Notification container -->
    <div id="notifications" class="notifications"></div>
    
    <div class="container">
        <div class="header">
            <h1>🔐 Browser Identity & DPoP Security</h1>
        </div>

        <div class="demo-section fade-in">
            <h2>🔧 Browser Session</h2>            
            <div class="session-status-card">
                <div id="sessionStatusIndicator" class="status-indicator">
                    <div class="status-content">
                        <div class="status-text">
                            <span class="status-title">Initializing session...</span>
                        </div>
                        <div class="status-detail">Checking for existing browser identity and session</div>
                        <div id="signalSummary" class="signal-summary" style="display: none;">
                            <div class="signal-header">
                                <span class="signal-title">Risk Signal Summary</span>
                                <button id="signalDetailsBtn" class="signal-details-btn" title="View all signal data">
                                    <span class="btn-icon">More data...</span>
                                </button>
                            </div>
                            <div class="signal-row">
                                <div class="signal-item">   
                                    <span class="signal-label">Location:</span>
                                    <span class="signal-value" id="signalLocation">--</span>
                                </div>
                                <div class="signal-item">
                                    <span class="signal-label">Device:</span>
                                    <span class="signal-value" id="signalDevice">--</span>
                                </div>
                                <div class="signal-item">
                                    <span class="signal-label">Browser:</span>
                                    <span class="signal-value" id="signalBrowser">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="demo-section fade-in">
            <h2>👤 User</h2>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Get started with your secure session:
            </p>
            
            <!-- Mode Toggle -->
            <div class="onboarding-toggle">
                <button id="registerModeBtn" class="toggle-btn active">📝 Register</button>
                <button id="signinModeBtn" class="toggle-btn">🔐 Sign In</button>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="onboarding-form">
                <div class="form-group">
                    <label for="usernameInput" class="form-label">Username</label>
                    <input type="text" id="usernameInput" class="form-control" placeholder="Choose a username" maxlength="50">
                    <div id="usernameError" class="form-error" style="display: none;"></div>
                </div>
                <button id="submitUsernameBtn" class="btn btn-primary">
                    📝 Register Username
                </button>
            </div>
            
            <!-- Sign In Form -->
            <div id="signinForm" class="onboarding-form" style="display: none;">
                <div class="form-group">
                    <label for="signinUsernameInput" class="form-label">Username</label>
                    <input type="text" id="signinUsernameInput" class="form-control" placeholder="Enter your username" maxlength="50">
                    <div id="signinError" class="form-error" style="display: none;"></div>
                </div>
                <button id="submitSigninBtn" class="btn btn-primary">
                    🔐 Sign In
                </button>
            </div>
        </div>

        <div class="demo-section fade-in">
            <h2>👤 Face Biometrics</h2>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Register and verify your face for enhanced security:
            </p>
            
            <div class="face-biometrics-form">
                <div class="face-actions">
                    <button id="registerFaceBtn" class="btn btn-secondary" disabled>
                        📸 Register Face
                    </button>
                    <button id="verifyFaceBtn" class="btn btn-secondary" disabled>
                        🔍 Verify Face
                    </button>
                </div>
                <div id="faceStatus" class="face-status" style="display: none;">
                    <div class="status-message"></div>
                </div>
                
                <!-- Face Capture UI (initially hidden) -->
                <div id="faceCaptureContainer" class="face-capture-container" style="display: none;">
                    <div class="face-capture-status">
                        <span class="face-status-text" id="status">Initializing camera...</span>
                    </div>

                    <div class="face-capture-row">
                        <div class="face-capture-col">
                            <div class="face-preview-wrap">
                                <video id="video" playsinline muted></video>
                                <canvas id="canvas"></canvas>
                                <div class="face-overlay"></div>
                            </div>
                        </div>
                        <div class="face-capture-col">
                            <div class="face-prompt" id="prompt">Ready.</div>
                            <div class="face-chips">
                                <div class="face-chip" id="chipFace">Face detected</div>
                                <div class="face-chip" id="chipCenter">Center face</div>
                                <div class="face-chip" id="chipLeft">Turn LEFT</div>
                                <div class="face-chip" id="chipRight">Turn RIGHT</div>
                            </div>
                            <div class="face-result" id="resultBox">
                                <div><strong>Processing face registration...</strong></div>
                                <div style="margin-top:6px;">
                                    <span class="face-pill" id="pillDuration">-- s</span>
                                    <span class="face-pill" id="pillSize">-- KB</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="demo-section fade-in">
            <h2>🎮 Interactive Demo</h2>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Follow the execution story below to experience the complete browser identity and cryptographic security workflow:
            </p>
            
            <div class="demo-sequence">
                <div class="sequence-step">
                    <div class="step-number">1</div>
                    <button id="apiBtn" class="btn btn-primary" disabled>
                        🌐 Test API Access
                    </button>
                    <button class="info-btn" data-tooltip="Tests the DPoP-protected API endpoint. Each request is cryptographically signed with the browser's private key, proving possession of the registered identity.">💬</button>
                </div>
                <div class="sequence-step">
                    <div class="step-number">2</div>
                    <button id="regBtn" class="btn btn-secondary" disabled>
                        📝 Register Passkey
                    </button>
                    <button class="info-btn" data-tooltip="Creates a WebAuthn passkey for this domain using the device's biometric authenticator or security key. This enables passwordless authentication.">💬</button>
                </div>
                <div class="sequence-step">
                    <div class="step-number">3</div>
                    <button id="authBtn" class="btn btn-secondary" disabled>
                        🔐 Authenticate Passkey
                    </button>
                    <button class="info-btn" data-tooltip="Authenticates using the registered passkey. This demonstrates biometric or security key verification for step-up authentication.">💬</button>
                </div>
                <div class="sequence-step">
                    <div class="step-number">4</div>
                    <button id="linkBtn" class="btn btn-accent" disabled>
                        📱 Start Device Linking (VDI/Step-up)
                    </button>
                    <button class="info-btn" data-tooltip="Initiates cross-device linking for VDI environments or step-up authentication. Generates a QR code that can be scanned by a mobile device to establish a secure connection.">💬</button>
                </div>
            </div>

            <!-- API Test Modal -->
            <div id="apiModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>🧪 Test API with DPoP</h3>
                        <span class="close" id="closeApiModal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="apiMessage">Message to send to server:</label>
                            <textarea id="apiMessage" class="form-control" rows="3" placeholder="Enter your message here...">Hello from Browser Identity & DPoP Security Demo!</textarea>
                        </div>
                        <div class="request-response-grid">
                            <div class="form-group">
                                <label>📤 Client Request (with DPoP):</label>
                                <div id="clientRequest" class="response-box">
                                    <em>Request details will appear here...</em>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>📥 Server Response:</label>
                                <div id="apiResponse" class="response-box">
                                    <em>Click "Send Request" to test the API...</em>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="sendApiRequest" class="btn btn-primary">Send Request</button>
                        <button id="cancelApiRequest" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="demo-section fade-in">
            <h2>🔧 Admin & Testing</h2>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Administrative functions for clearing server and client state:
            </p>
            
            <div class="button-grid">
                <button id="flushBtn" class="btn btn-secondary">
                    🗑️ Server Flush
                </button>
                <button id="clientFlushBtn" class="btn btn-secondary">
                    🧹 Client Flush
                </button>
            </div>
        </div>



        <div class="demo-section fade-in">
            <h2>📝 Activity Log</h2>
            <div class="log-section" id="logContainer">
                <div class="log-entry info">[INFO] Demo page loaded. Ready to start the browser identity journey!</div>
            </div>
        </div>
    </div>

    <!-- Signal Details Modal -->
    <div id="signalDetailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📊 Complete Signal Data</h3>
                <button class="modal-close" id="signalModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div id="signalDetailsContent">
                    <div class="loading-text">Loading signal data...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="/public/vendor/qrcode.min.js"></script>
    <script src="/public/js/browser.js"></script>
    <script src="/public/js/apriltag.js"></script>
    <script type="module" src="/public/js/app.js"></script>

</body>
</html>
