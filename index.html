<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Registration Demo</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/crypto.js"></script>
</head>
<body>
    <div class="container">
        <h1>Device Registration Demo</h1>
        
        <form id="registerForm">
            <div class="form-group">
                <label for="publicKey">Public Key:</label>
                <textarea id="publicKey" name="publicKey" placeholder="Enter your public key here or generate one..." required></textarea>
                <button type="button" onclick="generateNewKey()" style="margin-top: 10px;">Generate New Key Pair</button>
            </div>
            <button type="submit">Register Device</button>
        </form>
        
        <div id="result" class="result"></div>
        
        <div class="devices-section">
            <h2>Registered Devices</h2>
            <button onclick="loadDevices()">Refresh Devices</button>
            <div id="devicesList"></div>
        </div>
    </div>

    <script>
        async function generateNewKey() {
            try {
                showResult('Generating new key pair...', 'info');
                
                const keyData = await CryptoUtils.generateKeyPairWithId();
                
                document.getElementById('publicKey').value = keyData.publicKey;
                
                showResult(`New key pair generated! Key ID: ${keyData.keyId}`, 'success');
                
                console.log('Generated key pair:', {
                    keyId: keyData.keyId,
                    publicKey: keyData.publicKey
                });
                
            } catch (error) {
                showResult(`Error generating key: ${error.message}`, 'error');
                console.error('Key generation error:', error);
            }
        }

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const publicKey = document.getElementById('publicKey').value.trim();
            const resultDiv = document.getElementById('result');
            
            if (!publicKey) {
                showResult('Please enter a public key', 'error');
                return;
            }
            
            // Validate the public key format
            if (!CryptoUtils.validatePublicKey(publicKey)) {
                showResult('Invalid public key format. Please generate a new key or enter a valid base64-encoded public key.', 'error');
                return;
            }
            
            try {
                const response = await fetch('/register-device', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        public_key: publicKey
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showResult(`Device registered successfully! Device ID: ${data.device_id}`, 'success');
                    document.getElementById('publicKey').value = '';
                    loadDevices(); // Refresh the devices list
                } else {
                    // Handle different error types
                    if (response.status === 409) {
                        showResult(`Duplicate device: ${data.detail}`, 'warning');
                    } else {
                        showResult(`Registration failed: ${data.detail || data.error}`, 'error');
                    }
                }
            } catch (error) {
                showResult(`Error: ${error.message}`, 'error');
            }
        });
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }
        
        async function removeDevice(deviceId) {
            if (!confirm(`Are you sure you want to remove device ${deviceId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/devices/${deviceId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult(`Device ${deviceId} successfully removed`, 'success');
                    loadDevices(); // Refresh the devices list
                } else {
                    showResult(`Failed to remove device: ${data.detail || data.error}`, 'error');
                }
            } catch (error) {
                showResult(`Error: ${error.message}`, 'error');
            }
        }
        
        async function loadDevices() {
            try {
                const response = await fetch('/devices');
                const data = await response.json();
                
                const devicesList = document.getElementById('devicesList');
                
                if (data.success && Object.keys(data.devices).length > 0) {
                    devicesList.innerHTML = '';
                    Object.entries(data.devices).forEach(([deviceId, deviceInfo]) => {
                        const deviceDiv = document.createElement('div');
                        deviceDiv.className = 'device-item';
                        deviceDiv.innerHTML = `
                            <div class="device-info">
                                <strong>Device ID:</strong> ${deviceId}<br>
                                <strong>Public Key:</strong> ${CryptoUtils.formatPublicKey(deviceInfo.public_key, 50)}<br>
                                <strong>Registered:</strong> ${deviceInfo.registered_at}
                            </div>
                            <div class="device-actions">
                                <button class="btn-danger" onclick="removeDevice('${deviceId}')">Remove</button>
                            </div>
                        `;
                        devicesList.appendChild(deviceDiv);
                    });
                } else {
                    devicesList.innerHTML = '<p>No devices registered yet.</p>';
                }
            } catch (error) {
                console.error('Error loading devices:', error);
            }
        }
        
        // Load devices on page load
        loadDevices();
    </script>
</body>
</html> 